<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-grid/iron-grid.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input-char-counter.html">
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link href="https://fonts.googleapis.com/css?family=Roboto:100,200,300,400,500,600" rel="stylesheet">
<link rel="import" href="styles/animate-css.html">
<link rel="import" href="styles/twitter-style.html">
<dom-module id="my-home">
  <template>
    <style include="twitter-style animate-css">
      :host {
        display: block;
        height: 100%;
      }
      
      .whiteColor {
        background: white;
      }
      
      .americanFlagRed {
        background: #b22234;
        height: 100%;
      }
      
      iron-grid {
        height: 100%;
      }
      
      #twitterCard {
        width: 100%;
        background: white;
      }
      
      .tweet {
        width: 100%;
        padding: 20px;
      }
      
      .tweet_bottom_icons {
        --iron-image-width: 17px;
      }

      .tweet_bottom_icons_heart{
        --iron-image-height: 13px;
      }
      
      #shareImage_button {
        height: 40px;
        background: #2AA4EF;
        color: white;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        margin-top: 30px;
        width:100%;
        
      }
      
      paper-textarea {
        --paper-input-container-color: white;
        --paper-input-container-focus-color: white;
        --paper-input-container-label: {
          color: grey;
        }
        max-width:660px;
        --paper-input-char-counter:{
          color:grey!important;
        }
      }
      
      .baner_Image {
        --iron-image-width: 100%;
        /*max-width:800px;*/
      }
      
      @media (min-width:1200px) {
        .baner_Image {
          max-width: 60%;
          margin-left: auto;
          margin-right: auto;
        }
      }
      
      @media (min-width:900px) and (max-width:1199px) {
        .baner_Image {
          max-width: 80%;
          margin-left: auto;
          margin-right: auto;
        }
      }
      
      #donaldHandUp_Image {
        width: 100%;
        margin-top: 60px;
        /*padding-top: 40px;
        padding-left: 40px;
        padding-right: 40px;*/
      }
      /*#mainContent{
        background: red;
      }*/
      
      .greeting {
        font-size: 22pt;
        font-weight: 100;
        margin-left: auto;
        margin-right: auto;
        letter-spacing: 0.8px;
      }
      
      iron-icon {
        --iron-icon-fill-color: grey;
      }
      
      @media screen and (max-width: 480px) {
        .xs12 {
          margin-left: 0px !important;
          padding: 20px;
        }
        .greeting {
          font-size: 18pt;
        }
      }
      
      #tweet_picture_holder {
        margin-left: auto;
        margin-right: auto;
        width: 100%;
        display: flex;
        max-width: 700px;
      }
      
      #trump_tweet {
        width: 100% !important;
        margin-left: 0px;
        margin-right: 0px;
        max-width: none;
      }
      
      paper-spinner {
        --paper-spinner-layer-1-color: white;
        --paper-spinner-layer-2-color: yellow;
        --paper-spinner-layer-3-color: red;
        --paper-spinner-layer-4-color: black;
      }
      paper-button{
        --paper-button-disabled:{
          opacity:0.6;
        }
      }
    </style>
    <iron-grid xs-max-width="300" s-max-width="650" class="animated fadeIn">
      <!--<div class=" s0 m2 americanFlagRed"></div>-->
      <div class="offset-s0 offset-m1 s12 m10 whiteColor" style="padding-left:0px; padding-right:0px; padding-bottom:0.65em;">
        <iron-image class="baner_Image" style="margin-left:auto; margin-right: auto;" src="../images/png/banner.png" preload></iron-image>
        <!------Start of twitter stuff------>

        <div id="twitterCard">
          <div class="permalink-inner permalink-tweet-container">
            <iron-grid>
              <div class="offset-m1 offset-xs0 xs12 m10 ">
                <div class="greeting" style="width: 100%;">
                  <p style="margin-top:60px; max-width: 600px; margin-left:auto; margin-right: auto;">Congratulations, Mr. President. </p>
                  <p style="margin-top: 30px; max-width: 600px; margin-left:auto; margin-right: auto;">You are now the <i>most powerful man in the world</i>. Before you use this tool, you must know that <i>your voice, your words, and your actions can change our world for the better or for the worse.</i></p>

                  <p style="margin-top: 30px; max-width: 600px; margin-left:auto; margin-right: auto;">So please...please use it with care.</p>
                </div>
                <br>
                <div id="tweet_picture_holder">
                  <div style="margin-top:50px; width:initial;" id="trump_tweet" class=" card tweet permalink-tweet">
                    <div class="content clearfix">
                      <div class="permalink-header">
                        <a class="account-group js-account-group js-action-profile js-user-profile-link js-nav" data-user-id="25073877">
                          <img class="avatar js-action-profile-avatar" src="../images/png/djt_head.jpg" alt="">
                          <strong class="fullname js-action-profile-name show-popup-with-id" data-aria-label-part="">Donald J. Trump<iron-image class="Icon" style="position: absolute; margin-left:4px;" src="../images/png/ic_verify.png" ></strong>
                          <span>&rlm;</span><span class="username js-action-profile-name" data-aria-label-part=""><s>@</s><b>realDonaldTrump</b></span>
                        </a>
                        <!--<small class="time">
                          <a  class="tweet-timestamp js-permalink js-nav js-tooltip" title="10:00 AM - 20 Jan 2017" data-conversation-id="822504142178500608"><span class="_timestamp js-short-timestamp js-relative-timestamp" data-time="1484935243" data-time-ms="1484935243000" data-long-form="true" aria-hidden="true">8h</span><span class="u-hiddenVisually" data-aria-label-part="last">8 hours ago</span></a>
                        </small>-->
                        <div class="follow-bar">
                          <div class="user-actions btn-group not-following not-muting  " data-user-id="25073877" data-screen-name="realDonaldTrump"
                            data-name="Donald J. Trump" data-protected="false">
                            <button class="user-actions-follow-button js-follow-btn follow-button btn" type="button">
                          <span class="button-text follow-text" style="margin-top:4px;">
                           <iron-image class="Icon" style="margin-bottom:3px" src="../images/png/follow_icon.png" ></iron-image>Follow 
                            
                          </span>
                          
                        </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="js-tweet-text-container">
                    <paper-textarea id="input-textArea" label="{{myLabel}}" value="{{userInput}}" char-counter maxlength="140">
                      <paper-input-char-counter></paper-input-char-counter>
                    </paper-textarea>
                  </div>
                  <div class="js-tweet-details-fixer tweet-details-fixer">
                    <div class="js-machine-translated-tweet-container"></div>
                    <div class="js-tweet-stats-container tweet-stats-container">
                      <ul class="stats" aria-label="Retweeted and favorited by">
                        <li class="js-stat-count js-stat-retweets stat-count" aria-hidden="true">
                          <a tabindex="0" role="button" data-tweet-stat-count="10433" data-compact-localized-count="10K" class="request-retweeted-popup"
                            data-activity-popup-title="10,433 retweets">
                            Retweets <strong>10,433</strong>
                            </a>
                        </li>
                        <li class="js-stat-count js-stat-favorites stat-count" aria-hidden="true">
                          <a tabindex="0" role="button" data-tweet-stat-count="54820" data-compact-localized-count="55K" class="request-favorited-popup"
                            data-activity-popup-title="54,820 likes">
                            Likes <strong>54,820</strong>
                            </a>
                        </li>
                        <li class="avatar-row js-face-pile-container">
                          <a class="js-profile-popup-actionable js-tooltip" data-user-id="930429612" original-title="Robert Golden" title="Robert Golden"
                            rel="noopener">
                            <img class="avatar size24 js-user-profile-link" src="../images/png/follower_1.jpeg" alt="Robert Golden">
                            </a>
                            <a class="js-profile-popup-actionable js-tooltip" data-user-id="3084231070" original-title="Wanda Brewington" title="Wanda Brewington"
                              rel="noopener">
                              <img class="avatar size24 js-user-profile-link" src="../images/png/follower_2.png" alt="Wanda Brewington">
                              </a>
                              <a class="js-profile-popup-actionable js-tooltip" data-user-id="755004241383751680" original-title="TrumpPepe2020" title="TrumpPepe2020"
                                rel="noopener">
                                <img class="avatar size24 js-user-profile-link" src="../images/png/follower_3.jpg" alt="TrumpPepe2020">
                                </a>
                                <a class="js-profile-popup-actionable js-tooltip" data-user-id="3303150538" original-title="Thomas Jon IV" title="Thomas Jon IV"
                                  rel="noopener">
                                  <img class="avatar size24 js-user-profile-link" src="../images/png/follower_4.jpg" alt="Thomas Jon IV">
                                  </a>
                                  <a class="js-profile-popup-actionable js-tooltip" data-user-id="3439191809" original-title="Zachary Lippincott" title="Zachary Lippincott"
                                    rel="noopener">
                                    <img class="avatar size24 js-user-profile-link" src="../images/png/follower_5.jpg" alt="Zachary Lippincott">
                                    </a>
                                    <a class="js-profile-popup-actionable js-tooltip" data-user-id="758491129104834560" original-title="Hillary Diane" title="Hillary Diane"
                                      rel="noopener">
                                      <img class="avatar size24 js-user-profile-link" src="../images/png/follower_6.png" alt="Hillary Diane">
                                      </a>
                                      <a class="js-profile-popup-actionable js-tooltip" data-user-id="822447154182688768" original-title="Sandra Darby" title="Sandra Darby"
                                        rel="noopener">
                                        <img class="avatar size24 js-user-profile-link" src="../images/png/follower_7.png" alt="Sandra Darby">
                                        </a>
                                        <a class="js-profile-popup-actionable js-tooltip" data-user-id="818129288763351040" original-title="Patti Collis" title="Patti Collis"
                                          rel="noopener">
                                          <img class="avatar size24 js-user-profile-link" src="../images/png/follower_8.png" alt="Patti Collis">
                                          </a>
                        </li>
                      </ul>
                    </div>
                    <div class="client-and-actions">
                      <span class="metadata">
                        <span>2:00 AM - 16 Apr 2017</span>
                      </span>
                    </div>
                  </div>
                  <div class="stream-item-footer">
                    <div class="ProfileTweet-actionCountList u-hiddenVisually">
                      <span class="ProfileTweet-action--reply u-hiddenVisually">
                          <span class="ProfileTweet-actionCount" data-tweet-stat-count="4775">
                            <span class="ProfileTweet-actionCountForAria" data-aria-label-part="">4,775 replies</span>
                      </span>
                      </span>
                      <span class="ProfileTweet-action--retweet u-hiddenVisually">
                          <span class="ProfileTweet-actionCount" data-tweet-stat-count="10433">
                            <span class="ProfileTweet-actionCountForAria" data-aria-label-part="">10,433 retweets</span>
                      </span>
                      </span>
                      <span class="ProfileTweet-action--favorite u-hiddenVisually">
                          <span class="ProfileTweet-actionCount" data-tweet-stat-count="54820">
                            <span class="ProfileTweet-actionCountForAria" data-aria-label-part="">54,820 likes</span>
                      </span>
                      </span>
                    </div>
                    <div class="ProfileTweet-actionList js-actions buffer-inserted pocket-inserted" role="group" aria-label="Tweet actions">
                      <div class="ProfileTweet-action ProfileTweet-action--reply">
                        <button class="ProfileTweet-actionButton u-textUserColorHover js-actionButton js-actionReply" data-modal="ProfileTweet-reply"
                          type="button">
                          <div class="IconContainer js-tooltip" title="Reply">
                            <iron-image class="Icon tweet_bottom_icons" src="../images/png/ic_replypng.png"></iron-image>
                            <span class="u-hiddenVisually">Reply</span>
                          </div>
                          <div class="IconTextContainer">
                            <span class="ProfileTweet-actionCount ">
                              <span class="ProfileTweet-actionCountForPresentation" aria-hidden="true">4.8K</span>
                            </span>
                          </div>
                          </button>
                      </div>
                      <div class="ProfileTweet-action ProfileTweet-action--retweet js-toggleState js-toggleRt">
                        <button class="ProfileTweet-actionButton  js-actionButton js-actionRetweet" data-modal="ProfileTweet-retweet" type="button">
                                      <div class="IconContainer js-tooltip" title="Retweet">
                                        <iron-image class="Icon tweet_bottom_icons" src="../images/png/ic_retweetpng.png" ></iron-image>
                                        <span class="u-hiddenVisually">Retweet</span>
                                      </div>
                                        <div class="IconTextContainer">
                                          <span class="ProfileTweet-actionCount">
                                            <span class="ProfileTweet-actionCountForPresentation" aria-hidden="true">10K</span>
                                          </span>
                                        </div>
                                    </button>
                      </div>
                      <div class="ProfileTweet-action ProfileTweet-action--favorite js-toggleState" style="height: 100%; display: inline-flex;">
                        <button class="ProfileTweet-actionButton js-actionButton js-actionFavorite" type="button">
                                        <div class="IconTextContainer" style="display: inline-flex; align-items: flex-end;">
                              <iron-image style="margin-right: 5px; " class="Icon tweet_bottom_icons_heart" src="../images/png/ic_likepng.png" ></iron-image>
                              <span class="ProfileTweet-actionCountForPresentation" aria-hidden="true">55K</span>
                          </div>
                      </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          </div>
          </iron-grid>
         
          
            <div style="flex-direction: column;" class="offset-s2 s8 ">
              <paper-button id="shareImage_button" on-tap="takePicture" raised  >Make your fake tweet
                <paper-spinner id="paperSpinner" style="margin-left: 15px;"></paper-spinner>
              </paper-button>
              <!--Moved iframe inside the grid-->
            </div>
            <div id="iframe_containter" style="width:100%;">
              <iframe src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Frumptweets.com&width=324&layout=standard&action=like&size=small&show_faces=true&share=true&height=80&appId=221420734992546"
          width="324" height="80" style="margin-top:1em; margin-left: auto; margin-right: auto; display: block;" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
            </div>
            
          </iron-grid>
          
        </div>
      </div>  
      <iron-image id="donaldHandUp_Image" class="baner_Image" style="margin-left:auto; margin-right: auto; margin-top:0; background: white; bottom: -10px;"
            src="../images/png/donald_hand_up.png"></iron-image>
      </div>
    </iron-grid>
    <paper-dialog id="paperDialog" class$="{{dialogCss}}" horizontal-offset="20">
      <h2>Share your image</h2>
      <div id="scrollOutside" style="width:initial; overflow: auto;">
        <iron-image id="image_preview" style="width:500px; height:260px;" src="{{imageLink}}" preload sizing="contain"></iron-image>
      </div>
      <paper-item>imageUri: {{imageLink}}</paper-item>
      <div id="share_buttons" class="buttons">
        <!--<paper-button dialog-dismiss>Download Image</paper-button>
        <paper-button dialog-confirm autofocus>Accept</paper-button>-->
        <paper-button on-tap="downloadImage" style="color:grey;">
          <iron-icon icon="icons:file-download" style="margin-right:8px;"></iron-icon> {{downloadText}}</paper-button>
        <!--<paper-button disabled><iron-icon  src="../images/png/ic_twitter.png" style="margin-right:8px;"></iron-icon> {{shareText}}</paper-button>-->
        <paper-button on-tap="facebookShare"><iron-icon  src="../images/png/ic_facebook.png" style="margin-right:8px;"></iron-icon> {{shareText}}</paper-button>
      </div>
    </paper-dialog>

    <iron-media-query query="(min-width: 600px)" query-matches="{{mobilePhone}}"></iron-media-query>
    <paper-toast id="toast" text="Hmm there seems to be a problem generating your tweet. Please try again in a moment" duration="7000"></paper-toast>
  </template>

  <script>
    var globalThis;
    Polymer({
      is: 'my-home',
      properties: {
        userInput: {
          type: String,
          value: "",
          notify: true,
          observer: "_userInputChange"
        },
        myLabel: {
          type: String,
          value: "Click to start typing...",
          notify: true,
        },
        prop1: {
          type: String,
          value: 'RumpTweets-app',
        },
        user: {
          type: Object,
          value: {},
          observer: '_userStatusChange'
        },
        imageLink: {
          type: String,
          notify: true,
          value: ""
        },
        publicImageLink: {
          type: String,
          notify: true,
          value: ""
        },
        mobilePhone: {
          type: Boolean,
          notify: true,
          observer: '_mobilePhoneChange'
        },
        hideShareText: {
          type: Boolean,
          notify: true,
          value: false
        },
        shareText: {
          type: String,
          notify: true,
          value: "Share"
        },
        downloadText: {
          type: String,
          notify: true,
          value: "Download"
        },
        dialogCss: {
          type: String,
          value: "animated pulse"
        },
        responseText: {
          type: Object
        },
        postData: {
          type: Object
        }
      },
      listeners: {
        // this event is fired when the animation finishes
        'iron-overlay-canceled': '_closeTheDialog',
      },
      _closeTheDialog: function (e) {
        e.preventDefault();
        this.dialogCss = "animated zoomOutDown";
        setTimeout(function () {
          globalThis.$.paperDialog.close();
        }, 1300);
      },
      _userInputChange: function () {
        if (this.userInput == "") {
          this.myLabel = "Click to start typing...";
          console.log("yeah");
          this.$.shareImage_button.disabled = true;
        } else {
          this.myLabel = "";
          this.$.shareImage_button.disabled = false;
        }
      },
      //Remove words on download dialog and the margin right based on width of screen
      _mobilePhoneChange: function (newValue, oldValue) {
        var allIronImages = Polymer.dom(this.root).querySelectorAll("iron-icon");
        if (newValue == false) {
          this.shareText = "";
          this.downloadText = "";
          //get all the iron-icons and remove the paddings
          for (item in allIronImages) {
            var ironIconItem = allIronImages[item];
            ironIconItem.style.marginRight = "0px";
          }
        } else {
          this.shareText = "Share";
          this.downloadText = "Download";
          //get all the iron-icons and add the paddings
          for (item in allIronImages) {
            var ironIconItem = allIronImages[item];
            ironIconItem.style.marginRight = "4px";
          }
        }

      },
      _userStatusChange: function () {
        globalUid = this.user.uid;
        ga('set', 'userId', this.user.uid); // Set the user ID using signed-in user_id.
      },
      //Callback when the system is ready
      ready: function () {
        var rootThis = this;
        //Testing facebook
        // setTimeout(()=>{
        //   rootThis.facebookShare();
        // },2000);
        ga('set', {
          page: '/home_page',
          title: 'Home Page'
        });
        //TODO: need to find a fix to this omg so ugly !!!
        ga('set', 'userId', globalUid);
        ga('send', 'pageview');
      
        
        var donaldTrunpHandUp = Polymer.dom(rootThis.root).querySelector("#donaldHandUp_Image");
        var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || safari.pushNotification);
        var isSafariMobile = !!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/);
        var isChromeIos = navigator.userAgent.match('CriOS');
        var imageContainer;
        if (isSafari || isSafariMobile || isChromeIos) {
          imageContainer = donaldTrunpHandUp.querySelector("img");
        } else {
          imageContainer = donaldTrunpHandUp.root.querySelector("img");
        }
        imageContainer.style.maxWidth = "800px";
        imageContainer.style.marginLeft = "auto";
        imageContainer.style.marginRight = "auto";

        setTimeout(function () {
          firebase.auth().signInAnonymously().catch(function (error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
          });

          firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
              // User is signed in.
              var isAnonymous = user.isAnonymous;
              var uid = user.uid;
              rootThis.user = user;

            } else {

            }

          });
        }, 2000);
      },
      //Listners

      userTyped: function () {
        if (this.userInput == "") {
          this.myLabel = "Click to start typing...";
        } else {
          this.myLabel = "";
        }
      },
      //Take the picture and post to server
      takePicture: function () {
        globalThis = this;
        this.dialogCss = "animated pulse"
        this.$.paperSpinner.active = true;
        var rootThis = this;
        //get ref to new key
        var newPostKey = firebase.database().ref().child('Posts/' + rootThis.user.uid + '/').push().key;
        var postData = {
          userId: this.user.uid,
          imagePostId: newPostKey,
          message: this.userInput
        };
        //To use for send data to fb
        this.postData = postData;
        this.makeImage(postData);
      },
      makeImage: function (data) {
        var oReq = new XMLHttpRequest();
        oReq.addEventListener("load",function(){globalThis.makeImageDoneListener(event,data)});
        oReq.addEventListener("error", this.makeImageErrorListener);
        //oReq.withCredentials = false;
        var url = window.location.href;
        var postUrl;
        if(url.indexOf("test")!=-1){
          //develop is part of the url were being hosted
          postUrl = "http://localhost:8080/api/gentweet";
        }
        else if(url.indexOf("develop")!=-1){
          //develop is part of the url were being hoested
          postUrl = "http://localhost:8080/api/gentweet";
        }else{
          //it is the local host or it's been deployed; use the main link
          postUrl = "http://localhost:8080/api/gentweet";
        }
        // https://tump-tweet-generator-dot-rumptweets-2c7cc.appspot-preview.com/api/gentweet
        oReq.open("POST", postUrl);
        oReq.setRequestHeader("content-type", "application/json");
        oReq.send(JSON.stringify(data));
        //Send analytics 
        ga('set', 'userId', this.user.uid);
        ga('send', 'event', {
          eventCategory: 'Generate Image',
          eventAction: 'click',
          eventLabel: "https://tump-tweet-generator-dot-rumptweets-2c7cc.appspot.com/api/gentweet",
          transport: 'beacon'
        });
      },
      shortenUrl: function (data) {
        var oReq = new XMLHttpRequest();
        oReq.addEventListener("load", this.reqListener);
        oReq.open("POST", "https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyAPSrWdW13qN6-YAIrgZO_0F4CHdE2E4d0", true);
        oReq.setRequestHeader('Content-Type', 'application/json');
        oReq.send(JSON.stringify({ "longUrl": data }));
      },
      reqListener: function (event) {

        var paperDialog = Polymer.dom(globalThis.root).querySelector("paper-dialog");
        var temp = JSON.parse(this.responseText);
        globalThis.imageLink = temp.id;
        globalThis.$.paperSpinner.active = false;
        paperDialog.open();
      },
      makeImageDoneListener: function (event,data) {
       globalThis.postDataToFireBase(data);
       globalThis.responseText = JSON.parse(event.target.responseText);
       globalThis.shortenUrl(JSON.parse(event.target.responseText).downloadUrl);
       ga('set', 'userId', globalThis.user.uid);
        ga('send', 'event', {
          eventCategory: 'Generate Image',
          eventAction: 'success',
          eventLabel: 'Server respose',
          transport: 'beacon'
        }, { nonInteraction: true });
      },
      makeImageErrorListener: function (event) {
        globalThis.$.toast.open();
        globalThis.$.paperSpinner.active = false;
        ga('set', 'userId', globalThis.user.uid);
        ga('send', 'event', {
          eventCategory: 'Generate Image',
          eventAction: 'error',
          eventLabel: 'Server respose',
          transport: 'beacon'
        }, { nonInteraction: true });
        ga('send', 'exception', {
          exDescription: event,
          exFatal: false
        });
      },
      postDataToFireBase: function(data){
        if(globalThis.user.uid!=undefined && globalThis.user.uid!=null){
          firebase.database().ref().child('Posts/' + globalThis.user.uid + '/' + data.imagePostId ).set(data);
        }else{
          //TODO: need to file bug report. firebase is null in a uiWebView
          //don't post to firebase
        }
      },
      downloadImage: function () {
        //Send analytics 
        ga('set', 'userId', this.user.uid);
        ga('send', 'event', {
          eventCategory: 'Download Image',
          eventAction: 'click',
          eventLabel: "User action",
          transport: 'beacon'
        });
        var a = document.createElement("a");
        a.href = this.imageLink;
        a.download = "rump_tweet.png";
        a.click();
      },

      facebookShare: function () {
        ga('set', 'userId', this.user.uid);
        ga('send', 'event', {
          eventCategory: 'Share Image',
          eventAction: 'click',
          eventLabel: "Facebook",
          transport: 'beacon'
        });
        var shareUrl = "https://" + window.location.hostname + "/tweetgallery/"+ this.postData.userId + "/" + this.postData.imagePostId;
        FB.ui(
          {
              method: 'share',
              name: 'Facebook Dialogs',
              href: shareUrl,
              picture: this.publicImageLink,
              caption: ' Make tweets like the most “powerful” man in the world, our President, Donald J Trump',
              description: 'Look, ma! I can tweet like Trump too!',
              mobile_iframe: true
          },
          function (response) {
              if (response && response.post_id) {
                 ga('set', 'userId', globalThis.user.uid);
                  ga('send', 'event', {
                    eventCategory: 'Share Image',
                    eventAction: 'success',
                    eventLabel: 'Facebook',
                    transport: 'beacon'
                  }, { nonInteraction: true });
              } else {
                   ga('set', 'userId', globalThis.user.uid);
                    ga('send', 'event', {
                      eventCategory: 'Share Image',
                      eventAction: 'fail',
                      eventLabel: 'Facebook',
                      transport: 'beacon'
                    }, { nonInteraction: true });
              }
          }
        );
      }


    });
  </script>
</dom-module>